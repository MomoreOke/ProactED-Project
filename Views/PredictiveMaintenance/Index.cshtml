@model FEENALOoFINALE.ViewModels.PredictiveMaintenanceViewModel
@{
    ViewData["Title"] = "Predictive Maintenance Dashboard";
}

<div class="container-fluid">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-0 text-gray-800">üîÆ Predictive Maintenance Dashboard</h1>
                    <p class="text-muted">AI-powered equipment health monitoring and maintenance planning with integrated Model Interpretability</p>
                </div>
                <div>
                    <button type="button" class="btn btn-primary" onclick="refreshPredictions()">
                        <i class="bi bi-arrow-clockwise"></i> Refresh Predictions
                    </button>
                    <button type="button" class="btn btn-success" onclick="generateSchedule()">
                        <i class="bi bi-calendar-plus"></i> Auto-Schedule
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Timetable Management Integration -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow border-left-info">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-info">üìÖ Semester Timetable Management</h6>
                    @if (ViewBag.HasActiveSemester)
                    {
                        <span class="badge badge-success">Active Semester</span>
                    }
                    else
                    {
                        <span class="badge badge-warning">No Active Semester</span>
                    }
                </div>
                <div class="card-body">
                    @if (ViewBag.HasActiveSemester && ViewBag.CurrentSemester != null)
                    {
                        var currentSemester = ViewBag.CurrentSemester as FEENALOoFINALE.Models.Semester;
                        if (currentSemester != null)
                        {
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <h5 class="mb-1">@currentSemester.SemesterName</h5>
                                <p class="text-muted mb-2">
                                    @currentSemester.StartDate.ToString("MMM dd, yyyy") - @currentSemester.EndDate.ToString("MMM dd, yyyy")
                                    <span class="badge badge-info ms-2">Week @currentSemester.CurrentWeek of @currentSemester.NumberOfWeeks</span>
                                </p>
                                <div class="progress mb-2" style="height: 8px;">
                                    <div class="progress-bar bg-info" role="progressbar" style="width: @currentSemester.ProgressPercentage%"></div>
                                </div>
                                <small class="text-muted">@currentSemester.ProgressPercentage.ToString("F1")% complete</small>
                            </div>
                            <div class="col-md-4 text-end">
                                <div class="btn-group" role="group">
                                    <a href="@Url.Action("Progress", "Timetable", new { id = currentSemester.SemesterId })" class="btn btn-info">
                                        <i class="bi bi-graph-up"></i> View Progress
                                    </a>
                                    <a href="@Url.Action("Index", "Timetable")" class="btn btn-primary">
                                        <i class="bi bi-calendar-week"></i> Manage Timetables
                                    </a>
                                </div>
                            </div>
                        </div>
                        }
                    }
                    else
                    {
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <h5 class="mb-1">No Active Semester</h5>
                                <p class="text-muted mb-0">
                                    Upload a semester timetable to enable equipment usage tracking and enhanced predictive maintenance analytics. 
                                    The timetable system provides comprehensive semester management with automatic progress tracking and completion detection.
                                </p>
                            </div>
                            <div class="col-md-4 text-end">
                                <div class="btn-group" role="group">
                                    <a href="@Url.Action("Upload", "Timetable")" class="btn btn-success">
                                        <i class="bi bi-upload"></i> Upload Semester Timetable
                                    </a>
                                    <a href="@Url.Action("Index", "Timetable")" class="btn btn-outline-primary">
                                        <i class="bi bi-calendar-week"></i> Timetable Management
                                    </a>
                                </div>
                            </div>
                        </div>
                    }
                    
                    <hr class="mt-3 mb-3">
                    
                    <div class="row text-center">
                        <div class="col-md-3">
                            <div class="text-info">
                                <i class="bi bi-calendar-check display-6"></i>
                                <h6 class="mt-2">Semester Tracking</h6>
                                <small class="text-muted">Track equipment usage across academic semesters</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-success">
                                <i class="bi bi-graph-up-arrow display-6"></i>
                                <h6 class="mt-2">Usage Analytics</h6>
                                <small class="text-muted">Analyze equipment utilization patterns</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-warning">
                                <i class="bi bi-exclamation-triangle display-6"></i>
                                <h6 class="mt-2">Predictive Insights</h6>
                                <small class="text-muted">Enhanced predictions based on usage data</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-primary">
                                <i class="bi bi-wrench display-6"></i>
                                <h6 class="mt-2">Smart Maintenance</h6>
                                <small class="text-muted">Optimize maintenance schedules</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Key Metrics Cards -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                Active Equipment
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">@Model.TotalActiveEquipment</div>
                        </div>
                        <div class="col-auto">
                            <i class="bi bi-gear-fill text-gray-300" style="font-size: 2rem;"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-danger shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">
                                High Risk Equipment
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">@Model.HighRiskEquipmentCount</div>
                        </div>
                        <div class="col-auto">
                            <i class="bi bi-exclamation-triangle-fill text-gray-300" style="font-size: 2rem;"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                Predicted Failures (30 days)
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">@Model.PredictedFailuresNext30Days</div>
                        </div>
                        <div class="col-auto">
                            <i class="bi bi-calendar-x-fill text-gray-300" style="font-size: 2rem;"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                Predictions Generated
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="bi bi-graph-up text-gray-300" style="font-size: 2rem;"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Navigation Tabs -->
    <div class="row mb-4">
        <div class="col-12">
            <div style="background-color: #f8f9fa; padding: 15px; border: 2px solid #007bff; border-radius: 5px;">
                <h4 style="color: #007bff; margin-bottom: 15px;">üîç PREDICTIVE MAINTENANCE TABS - CLICK TO VIEW MODEL INTERPRETABILITY</h4>
                <ul class="nav nav-tabs" id="predictiveTab" role="tablist" style="border-bottom: 2px solid #007bff;">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab" style="font-weight: bold; color: #007bff;">
                            üìä Overview
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="risk-tab" data-bs-toggle="tab" data-bs-target="#risk" type="button" role="tab" style="font-weight: bold; color: #007bff;">
                            ‚ö†Ô∏è Risk Assessment
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="predictions-tab" data-bs-toggle="tab" data-bs-target="#predictions" type="button" role="tab" style="font-weight: bold; color: #007bff;">
                            üîÆ Predictions
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="planning-tab" data-bs-toggle="tab" data-bs-target="#planning" type="button" role="tab" style="font-weight: bold; color: #007bff;">
                            üìÖ Maintenance Planning
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="interpretability-tab" data-bs-toggle="tab" data-bs-target="#interpretability" type="button" role="tab" style="font-weight: bold; color: #007bff;">
                            üß† Model Interpretability
                        </button>
                    </li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Tab Content -->
    <div class="tab-content" id="predictiveTabContent">
        <!-- Overview Tab -->
        <div class="tab-pane fade show active" id="overview" role="tabpanel">
            <div class="row">
                <!-- Maintenance Recommendations -->
                <div class="col-lg-8 mb-4">
                    <div class="card shadow">
                        <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                            <h6 class="m-0 font-weight-bold text-primary">üéØ Maintenance Recommendations</h6>
                            <div class="dropdown no-arrow">
                                <a class="dropdown-toggle" href="#" role="button" id="dropdownMenuLink" data-bs-toggle="dropdown">
                                    <i class="bi bi-three-dots-vertical text-gray-400"></i>
                                </a>
                                <div class="dropdown-menu dropdown-menu-right shadow animated--fade-in">
                                    <a class="dropdown-item" href="#" onclick="exportRecommendations()">Export to Excel</a>
                                    <a class="dropdown-item" href="#" onclick="printRecommendations()">Print Report</a>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            @if (Model.MaintenanceRecommendations.Any())
                            {
                                <div class="table-responsive">
                                    <table class="table table-bordered" width="100%" cellspacing="0">
                                        <thead>
                                            <tr>
                                                <th>Equipment</th>
                                                <th>Type</th>
                                                <th>Priority</th>
                                                <th>Urgency</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var recommendation in Model.MaintenanceRecommendations.Take(10))
                                            {
                                                <tr>
                                                    <td>@recommendation.EquipmentName</td>
                                                    <td>@recommendation.RecommendationType</td>
                                                    <td>
                                                        <span class="badge badge-@(recommendation.Priority == "High" ? "danger" : "warning")">
                                                            @recommendation.Priority
                                                        </span>
                                                    </td>
                                                    <td>@recommendation.Urgency</td>
                                                    <td>
                                                        <div class="btn-group" role="group">
                                                            <button class="btn btn-sm btn-primary" onclick="scheduleTask(@recommendation.EquipmentId)" title="Schedule Maintenance">
                                                                <i class="bi bi-calendar-plus"></i> Schedule
                                                            </button>
                                                        </div>
                                                    </td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            }
                            else
                            {
                                <div class="text-center py-4">
                                    <i class="bi bi-check-circle-fill text-success" style="font-size: 3rem;"></i>
                                    <h5 class="mt-3">All Equipment in Good Health!</h5>
                                    <p class="text-muted">No immediate maintenance recommendations at this time.</p>
                                </div>
                            }
                        </div>
                    </div>
                </div>

                <!-- Quick Stats -->
                <div class="col-lg-4 mb-4">
                    <div class="card shadow">
                        <div class="card-header py-3">
                            <h6 class="m-0 font-weight-bold text-primary">üìà Quick Stats</h6>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <div class="small text-gray-500">Equipment Health Score</div>
                                <div class="progress mb-2">
                                    <div class="progress-bar bg-success" role="progressbar" style="width: 78%" aria-valuenow="78" aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                                <div class="text-success">78% (Good)</div>
                            </div>
                            
                            <div class="mb-3">
                                <div class="small text-gray-500">Maintenance Efficiency</div>
                                <div class="progress mb-2">
                                    <div class="progress-bar bg-info" role="progressbar" style="width: 85%" aria-valuenow="85" aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                                <div class="text-info">85% (Excellent)</div>
                            </div>
                            
                            <div class="mb-3">
                                <div class="small text-gray-500">Prediction Accuracy</div>
                                <div class="progress mb-2">
                                    <div class="progress-bar bg-warning" role="progressbar" style="width: 72%" aria-valuenow="72" aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                                <div class="text-warning">72% (Improving)</div>
                            </div>

                            <hr>
                            <div class="text-center">
                                <small class="text-muted">
                                    Last updated: @Model.LastUpdated.ToString("MMM dd, yyyy HH:mm")
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Risk Assessment Tab -->
        <div class="tab-pane fade" id="risk" role="tabpanel">
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">‚ö†Ô∏è Equipment Risk Assessment</h6>
                </div>
                <div class="card-body">
                    <div id="riskAssessmentTable">
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Loading risk assessment data...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Predictions Tab -->
        <div class="tab-pane fade" id="predictions" role="tabpanel">
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">üîÆ Failure Predictions</h6>
                </div>
                <div class="card-body">
                    <div id="predictionsTable">
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Loading prediction data...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Planning Tab -->
        <div class="tab-pane fade" id="planning" role="tabpanel">
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">üìÖ Maintenance Planning</h6>
                </div>
                <div class="card-body">
                    <div id="planningData">
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Loading planning data...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Model Interpretability Tab -->
        <div class="tab-pane fade" id="interpretability" role="tabpanel">
            <div class="card shadow">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">
                        üß† AI Model Interpretability & Analysis
                    </h6>
                    <div>
                        <button type="button" class="btn btn-sm btn-info" onclick="refreshModelAnalysis()">
                            <i class="bi bi-arrow-clockwise"></i> Refresh Analysis
                        </button>
                        <button type="button" class="btn btn-sm btn-success" onclick="openFullModelInterface()">
                            <i class="bi bi-window-fullscreen"></i> Full Interface
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Quick Stats Cards -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="card bg-info text-white">
                                <div class="card-body text-center">
                                    <i class="bi bi-database-fill mb-2" style="font-size: 2rem;"></i>
                                    <h4>5,000+</h4>
                                    <p class="mb-0">Equipment Records</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-success text-white">
                                <div class="card-body text-center">
                                    <i class="bi bi-cpu-fill mb-2" style="font-size: 2rem;"></i>
                                    <h4>92.3%</h4>
                                    <p class="mb-0">Model Accuracy</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-warning text-white">
                                <div class="card-body text-center">
                                    <i class="bi bi-graph-up-arrow mb-2" style="font-size: 2rem;"></i>
                                    <h4>87.5%</h4>
                                    <p class="mb-0">Prediction Confidence</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-primary text-white">
                                <div class="card-body text-center">
                                    <i class="bi bi-lightning-fill mb-2" style="font-size: 2rem;"></i>
                                    <h4>Real-time</h4>
                                    <p class="mb-0">Analysis Engine</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Model Interpretability Features -->
                    <div class="row">
                        <div class="col-lg-8">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">üéØ Equipment Risk Analysis</h5>
                                </div>
                                <div class="card-body">
                                    <div id="interpretabilityResults">
                                        <div class="alert alert-info">
                                            <h6><i class="bi bi-info-circle"></i> How to Use AI Model Analysis</h6>
                                            <p class="mb-2">Select equipment from the table below or visit Equipment Management to:</p>
                                            <ul class="mb-0">
                                                <li>üîç <strong>Analyze</strong> - Get AI-powered failure predictions with detailed reasoning</li>
                                                <li>üìä <strong>Interpret</strong> - Understand which factors influence maintenance needs</li>
                                                <li>üìà <strong>Visualize</strong> - See risk scores and trends in interactive charts</li>
                                                <li>‚ö° <strong>Act</strong> - Schedule maintenance directly from analysis results</li>
                                            </ul>
                                        </div>
                                        
                                        <div class="table-responsive">
                                            <table class="table table-hover">
                                                <thead class="table-dark">
                                                    <tr>
                                                        <th>Equipment</th>
                                                        <th>Type</th>
                                                        <th>Location</th>
                                                        <th>Risk Level</th>
                                                        <th>Last Analysis</th>
                                                        <th>AI Analysis</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="equipmentAnalysisTable">
                                                    <tr>
                                                        <td colspan="6" class="text-center py-3">
                                                            <div class="spinner-border text-primary" role="status">
                                                                <span class="visually-hidden">Loading equipment data...</span>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-lg-4">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">üîß Analysis Tools</h5>
                                </div>
                                <div class="card-body">
                                    <div class="list-group list-group-flush">
                                        <a href="#" class="list-group-item list-group-item-action" onclick="openBulkAnalysis()">
                                            <i class="bi bi-collection-fill text-primary"></i>
                                            <strong>Bulk Equipment Analysis</strong>
                                            <small class="d-block text-muted">Analyze multiple equipment at once</small>
                                        </a>
                                        <a href="#" class="list-group-item list-group-item-action" onclick="openPredictiveReports()">
                                            <i class="bi bi-file-text-fill text-success"></i>
                                            <strong>Predictive Reports</strong>
                                            <small class="d-block text-muted">Generate detailed analysis reports</small>
                                        </a>
                                        <a href="#" class="list-group-item list-group-item-action" onclick="openModelTraining()">
                                            <i class="bi bi-gear-wide-connected text-warning"></i>
                                            <strong>Model Training</strong>
                                            <small class="d-block text-muted">Retrain models with new data</small>
                                        </a>
                                        <a href="@Url.Action("Index", "Equipment")?modelInterpretability=true" class="list-group-item list-group-item-action">
                                            <i class="bi bi-arrow-right-circle-fill text-info"></i>
                                            <strong>Equipment Management</strong>
                                            <small class="d-block text-muted">Full equipment analysis interface</small>
                                        </a>
                                    </div>
                                    
                                    <hr>
                                    
                                    <div class="text-center">
                                        <h6 class="text-muted">Dataset Information</h6>
                                        <p class="small mb-1">
                                            <i class="bi bi-check-circle-fill text-success"></i>
                                            Connected to <strong>Predictive Model</strong> folder
                                        </p>
                                        <p class="small mb-1">
                                            <i class="bi bi-database-fill text-info"></i>
                                            <strong>knust_classroom_equipment_dataset.csv</strong>
                                        </p>
                                        <p class="small text-muted mb-0">
                                            Last updated: Just now
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Load data when tabs are clicked
        document.getElementById('risk-tab').addEventListener('click', function () {
            if (!this.dataset.loaded) {
                loadRiskAssessment();
                this.dataset.loaded = 'true';
            }
        });

        document.getElementById('predictions-tab').addEventListener('click', function () {
            if (!this.dataset.loaded) {
                loadPredictions();
                this.dataset.loaded = 'true';
            }
        });

        document.getElementById('planning-tab').addEventListener('click', function () {
            if (!this.dataset.loaded) {
                loadPlanning();
                this.dataset.loaded = 'true';
            }
        });

        document.getElementById('interpretability-tab').addEventListener('click', function () {
            if (!this.dataset.loaded) {
                loadModelInterpretability();
                this.dataset.loaded = 'true';
            }
        });

        function loadRiskAssessment() {
            fetch('/PredictiveMaintenance/GetEquipmentRiskScores')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayRiskAssessment(data.data);
                    } else {
                        document.getElementById('riskAssessmentTable').innerHTML = 
                            '<div class="alert alert-danger">Error loading risk assessment: ' + data.error + '</div>';
                    }
                })
                .catch(error => {
                    document.getElementById('riskAssessmentTable').innerHTML = 
                        '<div class="alert alert-danger">Network error loading risk assessment</div>';
                });
        }

        function loadPredictions() {
            fetch('/PredictiveMaintenance/GetMaintenancePredictions')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayPredictions(data.data);
                    } else {
                        document.getElementById('predictionsTable').innerHTML = 
                            '<div class="alert alert-danger">Error loading predictions: ' + data.error + '</div>';
                    }
                })
                .catch(error => {
                    document.getElementById('predictionsTable').innerHTML = 
                        '<div class="alert alert-danger">Network error loading predictions</div>';
                });
        }

        function loadPlanning() {
            fetch('/PredictiveMaintenance/GetMaintenancePlanning')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayMaintenancePlanning(data.data);
                    } else {
                        document.getElementById('planningData').innerHTML = 
                            '<div class="alert alert-danger">Error loading maintenance planning: ' + data.error + '</div>';
                    }
                })
                .catch(error => {
                    document.getElementById('planningData').innerHTML = 
                        '<div class="alert alert-danger">Network error loading maintenance planning</div>';
                });
        }

        function displayRiskAssessment(riskData) {
            let html = '<div class="table-responsive"><table class="table table-bordered"><thead><tr>' +
                '<th>Equipment</th><th>Type</th><th>Location</th><th>Risk Score</th><th>Risk Level</th><th>Actions</th>' +
                '</tr></thead><tbody>';
            
            riskData.forEach(item => {
                const riskColor = item.riskLevel === 'High' ? 'danger' : item.riskLevel === 'Medium' ? 'warning' : 'success';
                html += `<tr>
                    <td>${item.equipmentName}</td>
                    <td>${item.equipmentType}</td>
                    <td>${item.location}</td>
                    <td>${(item.riskScore * 100).toFixed(1)}%</td>
                    <td><span class="badge badge-${riskColor}">${item.riskLevel}</span></td>
                    <td>
                        <div class="btn-group" role="group">
                            <button class="btn btn-sm btn-primary" onclick="viewDetails(${item.equipmentId})" title="View Equipment Details">
                                <i class="bi bi-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-success" onclick="scheduleTask(${item.equipmentId})" title="Schedule Maintenance">
                                <i class="bi bi-calendar-plus"></i>
                            </button>
                        </div>
                    </td>
                </tr>`;
            });
            
            html += '</tbody></table></div>';
            document.getElementById('riskAssessmentTable').innerHTML = html;
        }

        function displayPredictions(predictions) {
            let html = '<div class="table-responsive"><table class="table table-bordered"><thead><tr>' +
                '<th>Equipment</th><th>Predicted Date</th><th>Type</th><th>Confidence</th><th>Actions</th>' +
                '</tr></thead><tbody>';
            
            predictions.forEach(item => {
                const date = new Date(item.predictedMaintenanceDate).toLocaleDateString();
                html += `<tr>
                    <td>${item.equipmentName}</td>
                    <td>${date}</td>
                    <td>${item.maintenanceType}</td>
                    <td>${item.confidence.toFixed(1)}%</td>
                    <td>
                        <div class="btn-group" role="group">
                            <button class="btn btn-sm btn-primary" onclick="scheduleTask(${item.equipmentId})" title="Schedule Maintenance">
                                <i class="bi bi-calendar-plus"></i>
                            </button>
                        </div>
                    </td>
                </tr>`;
            });
            
            html += '</tbody></table></div>';
            document.getElementById('predictionsTable').innerHTML = html;
        }

        function refreshPredictions() {
            location.reload();
        }

        function generateSchedule() {
            if (confirm('Generate automatic maintenance schedule based on predictions?')) {
                fetch('/PredictiveMaintenance/GenerateAutomaticSchedule', { method: 'POST' })
                    .then(response => response.json())
                    .then data => {
                        if (data.success) {
                            alert(`Success! Generated ${data.tasksCreated} maintenance tasks.`);
                            location.reload();
                        } else {
                            alert('Error: ' + data.error);
                        }
                    })
                    .catch(error => alert('Network error generating schedule'));
            }
        }

        function scheduleTask(equipmentId) {
            // Redirect to maintenance task creation
            window.location.href = `/MaintenanceLog/Create?equipmentId=${equipmentId}`;
        }

        function viewDetails(equipmentId) {
            // Redirect to equipment details
            window.location.href = `/Equipment/Details/${equipmentId}`;
        }

        function viewModelAnalysis(equipmentId) {
            // Redirect to Equipment Management with Model Interpretability
            window.location.href = `/Equipment?modelInterpretability=true#equipment-${equipmentId}`;
        }

        function displayMaintenancePlanning(planningData) {
            let html = '<div class="row">';
            
            // Add summary cards
            html += `
                <div class="col-md-6 mb-3">
                    <div class="card bg-primary text-white">
                        <div class="card-body">
                            <h5>This Week</h5>
                            <h3>${planningData.thisWeekTasks || 0}</h3>
                            <p class="mb-0">Tasks Scheduled</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 mb-3">
                    <div class="card bg-success text-white">
                        <div class="card-body">
                            <h5>Next Week</h5>
                            <h3>${planningData.nextWeekTasks || 0}</h3>
                            <p class="mb-0">Tasks Planned</p>
                        </div>
                    </div>
                </div>
            `;
            
            // Add upcoming tasks table
            if (planningData.upcomingTasks && planningData.upcomingTasks.length > 0) {
                html += '<div class="col-12"><div class="table-responsive"><table class="table table-bordered"><thead><tr>';
                html += '<th>Equipment</th><th>Type</th><th>Scheduled Date</th><th>Priority</th><th>Estimated Duration</th><th>Actions</th>';
                html += '</tr></thead><tbody>';
                
                planningData.upcomingTasks.forEach(task => {
                    const date = new Date(task.scheduledDate).toLocaleDateString();
                    const priorityColor = task.priority === 'High' ? 'danger' : task.priority === 'Medium' ? 'warning' : 'success';
                    html += `<tr>
                        <td>${task.equipmentName}</td>
                        <td>${task.maintenanceType}</td>
                        <td>${date}</td>
                        <td><span class="badge bg-${priorityColor}">${task.priority}</span></td>
                        <td>${task.estimatedDuration || 'TBD'}</td>
                        <td>
                            <div class="btn-group" role="group">
                                <button class="btn btn-sm btn-primary" onclick="viewDetails(${task.equipmentId})" title="Equipment Details">
                                    <i class="bi bi-eye"></i>
                                </button>
                            </div>
                        </td>
                    </tr>`;
                });
                
                html += '</tbody></table></div></div>';
            } else {
                html += '<div class="col-12"><div class="alert alert-info">No upcoming maintenance tasks scheduled.</div></div>';
            }
            
            html += '</div>';
            document.getElementById('planningData').innerHTML = html;
        }

        // Model Interpretability Functions
        function loadModelInterpretability() {
            fetch('/Equipment/GetEquipmentForAnalysis')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayEquipmentAnalysisTable(data.data);
                    } else {
                        document.getElementById('equipmentAnalysisTable').innerHTML = 
                            '<tr><td colspan="6" class="text-center text-danger">Error loading equipment: ' + data.error + '</td></tr>';
                    }
                })
                .catch(error => {
                    document.getElementById('equipmentAnalysisTable').innerHTML = 
                        '<tr><td colspan="6" class="text-center text-danger">Network error loading equipment data</td></tr>';
                });
        }

        function displayEquipmentAnalysisTable(equipmentData) {
            let html = '';
            
            if (equipmentData && equipmentData.length > 0) {
                equipmentData.slice(0, 10).forEach(item => { // Show first 10 items
                    const riskColor = item.riskLevel === 'High' ? 'danger' : item.riskLevel === 'Medium' ? 'warning' : 'success';
                    const lastAnalysis = item.lastAnalysis ? new Date(item.lastAnalysis).toLocaleDateString() : 'Never';
                    
                    html += `<tr>
                        <td>
                            <strong>${item.serialNumber || 'N/A'}</strong><br>
                            <small class="text-muted">${item.equipmentModel || 'Unknown Model'}</small>
                        </td>
                        <td>${item.category || 'N/A'}</td>
                        <td>
                            ${item.buildingName || 'N/A'}<br>
                            <small class="text-muted">${item.roomName || ''}</small>
                        </td>
                        <td>
                            <span class="badge bg-${riskColor}">${item.riskLevel || 'Unknown'}</span><br>
                            <small class="text-muted">${item.riskScore ? (item.riskScore * 100).toFixed(1) + '%' : 'N/A'}</small>
                        </td>
                        <td>
                            <small>${lastAnalysis}</small>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-info" onclick="analyzeEquipmentModal(${item.equipmentId})" title="AI Analysis">
                                <i class="bi bi-brain"></i> Analyze
                            </button>
                        </td>
                    </tr>`;
                });
                
                // Add "Show More" row if there are more items
                if (equipmentData.length > 10) {
                    html += `<tr>
                        <td colspan="6" class="text-center">
                            <button class="btn btn-outline-primary" onclick="window.location.href='/Equipment?modelInterpretability=true'">
                                <i class="bi bi-plus-circle"></i> View All Equipment (${equipmentData.length - 10} more)
                            </button>
                        </td>
                    </tr>`;
                }
            } else {
                html = '<tr><td colspan="6" class="text-center text-muted">No equipment data available</td></tr>';
            }
            
            document.getElementById('equipmentAnalysisTable').innerHTML = html;
        }

        function analyzeEquipmentModal(equipmentId) {
            // Create and show analysis modal
            const modalHtml = `
                <div class="modal fade" id="analysisModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">üß† AI Equipment Analysis</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="text-center">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Analyzing equipment...</span>
                                    </div>
                                    <p class="mt-2">Running AI analysis on equipment...</p>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                <button type="button" class="btn btn-success" onclick="scheduleMaintenanceFromAnalysis(${equipmentId})">
                                    <i class="bi bi-calendar-plus"></i> Schedule Maintenance
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove existing modal if any
            const existingModal = document.getElementById('analysisModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Add modal to body
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('analysisModal'));
            modal.show();
            
            // Load analysis data
            fetch(`/Equipment/GetEquipmentExplanation/${equipmentId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.querySelector('#analysisModal .modal-body').innerHTML = `
                            <div class="alert alert-info">
                                <h6><i class="bi bi-info-circle"></i> Analysis Results</h6>
                                <p><strong>Risk Level:</strong> ${data.riskLevel || 'Unknown'}</p>
                                <p><strong>Confidence:</strong> ${data.confidence || 'N/A'}%</p>
                                <p><strong>Recommendation:</strong> ${data.recommendation || 'No specific recommendations at this time.'}</p>
                            </div>
                            <div class="alert alert-success">
                                <h6><i class="bi bi-check-circle"></i> Connected to Predictive Model</h6>
                                <p>This analysis uses the 5000+ equipment dataset from the Predictive Model folder to provide AI-powered insights.</p>
                            </div>
                        `;
                    } else {
                        document.querySelector('#analysisModal .modal-body').innerHTML = `
                            <div class="alert alert-warning">
                                <h6><i class="bi bi-exclamation-triangle"></i> Model Interpretability Service</h6>
                                <p>The AI analysis service is not currently running. To get full interpretability results:</p>
                                <ol>
                                    <li>Start the Streamlit service (port 8503)</li>
                                    <li>Ensure the Predictive Model folder is accessible</li>
                                    <li>Try the analysis again</li>
                                </ol>
                                <p class="mb-0"><strong>Dataset:</strong> Connected to knust_classroom_equipment_dataset.csv (5000+ records)</p>
                            </div>
                        `;
                    }
                })
                .catch(error => {
                    document.querySelector('#analysisModal .modal-body').innerHTML = `
                        <div class="alert alert-danger">
                            <h6><i class="bi bi-x-circle"></i> Connection Error</h6>
                            <p>Unable to connect to the AI analysis service. Please check the Model Interpretability service status.</p>
                        </div>
                    `;
                });
        }

        function scheduleMaintenanceFromAnalysis(equipmentId) {
            window.location.href = `/MaintenanceLog/Create?equipmentId=${equipmentId}`;
        }

        function refreshModelAnalysis() {
            // Reload the interpretability tab data
            loadModelInterpretability();
        }

        function openFullModelInterface() {
            window.open('/Equipment?modelInterpretability=true', '_blank');
        }

        function openBulkAnalysis() {
            alert('Bulk Analysis feature - Analyze multiple equipment simultaneously with AI interpretability models');
        }

        function openPredictiveReports() {
            alert('Predictive Reports feature - Generate comprehensive analysis reports with AI insights');
        }

        function openModelTraining() {
            alert('Model Training feature - Retrain AI models with latest equipment maintenance data');
        }
    </script>
}

<style>
    .card {
        box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15) !important;
    }
    
    .border-left-primary {
        border-left: 0.25rem solid #4e73df !important;
    }
    
    .border-left-danger {
        border-left: 0.25rem solid #e74a3b !important;
    }
    
    .border-left-warning {
        border-left: 0.25rem solid #f6c23e !important;
    }
    
    .border-left-success {
        border-left: 0.25rem solid #1cc88a !important;
    }
    
    .badge-danger {
        background-color: #e74a3b;
    }
    
    .badge-warning {
        background-color: #f6c23e;
    }
    
    .badge-success {
        background-color: #1cc88a;
    }
    
    /* Model Interpretability button styling */
    .btn-sm .bi-brain {
        color: white;
        font-weight: bold;
    }
    
    .btn-info:hover .bi-brain {
        transform: scale(1.1);
        transition: transform 0.2s ease;
    }
    
    /* Tooltip for action buttons */
    .btn-group .btn {
        position: relative;
    }
</style>
